{"version":3,"file":"oxi.es.js","sources":["../src/html.ts","../src/format.ts","../src/worker-errors.ts","../src/worker.ts","../src/mutation-observer.ts","../src/wait-for-element-errors.ts","../src/wait-for-element.ts"],"sourcesContent":["\n\nexport const HTMLEntityMap = {\n    '&': '&amp;',\n    '<': '&lt;',\n    '>': '&gt;',\n    '\"': '&quot;',\n    \"'\": '&#39;',\n    '/': '&#x2F;',\n    '`': '&#x60;',\n    '=': '&#x3D;'\n} as const;\n\nexport function escapeHTML(text: string) {\n    return text.replace(/[&<>\"'`=\\/]/g, (s) => HTMLEntityMap[s as keyof typeof HTMLEntityMap]);\n}\n  \nexport function html<Elem extends Element>(template: readonly string[], ...subst: any[]): Elem {\n    const completeString = [];\n\n    for (let i = 0; i < template.length; i++) {\n        completeString.push(template[i]);\n        if (subst[i]) completeString.push(escapeHTML(String(subst[i])));\n    }\n\n    return fromHTML<Elem>(completeString.join(\"\"));\n}\n\nexport function fromHTML<Elem extends Element>(text: string): Elem {\n    const elem = document.createElement(\"div\");\n    elem.innerHTML = text;\n    setTimeout(() => elem.remove());\n    return elem.children[0] as Elem;\n}","\nexport interface FormatStringOptions {\n    subst: {\n        format: string;\n        var: string;\n    }\n}\n\nexport function escapeRegExp(text: string) {\n    return text.replace(/[.*+?^${}()|[\\]\\\\]/g, \"\\\\$&\"); // $& means the whole matched string\n}\n\nexport function formatString(\n        text: string,\n        dict: Record<string, any>,\n        { subst = { format: \"${{ | }}\", var: \"|\" } }: Partial<FormatStringOptions> = {}): string\n{\n    const substRegex = subst.format\n        .split(subst.var)\n        .map(escapeRegExp)\n        .join(String.raw`([$\\w\\d-_.: ]+)`);\n    return text.replace(new RegExp(substRegex, \"g\"), (_, varKey) => dict[varKey]?.toString());\n}","\nimport { Job, WorkerJQ } from \"worker\";\n\nexport class WorkerUnreponsiveError extends Error {\n    name = this.constructor.name;\n    worker: WorkerJQ;\n\n    constructor (worker: WorkerJQ) {\n        super(`worker is unresponsive`);\n        this.worker = worker;\n    }\n}\n\nexport class WorkerScriptError extends Error {\n    name = this.constructor.name;\n    worker: WorkerJQ;\n\n    constructor (worker: WorkerJQ, error: any) {\n        super(`script error caused by worker (${error.name})`);\n        this.worker = worker;\n        this.cause = error;\n    }\n}\n\nexport class WorkerDeadState extends Error {\n    name = this.constructor.name;\n    worker: WorkerJQ;\n\n    constructor (worker: WorkerJQ, state: string) {\n        super(`worker is in dead state (${state})`)\n        this.worker = worker;\n    }\n}\n\nexport class JobNotFound extends Error {\n    name = this.constructor.name;\n    worker: WorkerJQ;\n    job: Job<any>;\n\n    constructor (worker: WorkerJQ, job: Job<any>) {\n        super(\"job not found in worker\");\n        this.worker = worker;\n        this.job = job;\n    }\n}","\nimport type {\n    AwaitMessageInit,\n    ChildMessage,\n    ChildMessageExecutionResultError,\n    ChildMessageExecutionResultSuccess,\n    ChildMessageStatus,\n    Job,\n    WorkerJQOptions,\n    ParentMessage,\n    ParentMessageClose,\n    ParentMessageExecution,\n    ParentMessageExecutionAsync,\n    ParentMessageResume,\n    ParentMessageSuspend,\n} from \"./worker-types\";\n\nimport {\n    JobNotFound,\n    WorkerDeadState,\n    WorkerScriptError,\n    WorkerUnreponsiveError\n} from \"./worker-errors\";\n\nexport * from \"./worker-types\";\nexport * from \"./worker-errors\";\n\nexport class JobDoneEvent extends Event {\n    job: Job<any>;\n    result: any;\n\n    constructor ({ job, result }: { job: Job<any>, result: any }, options?: EventInit) {\n        super(\"job-done\", options);\n        this.job = job;\n        this.result = result;\n    }\n}\n\nfunction workerLoop() {\n    let state: WorkerJQ[\"state\"] = \"idling\";\n\n    function executeParentCode(data: ParentMessageExecution | ParentMessageExecutionAsync) {\n        state = \"working\";\n        const callback = eval(`(${data.functionCode})`);\n        const args = data.args;\n\n        try {\n            const returnValue = callback(...args);\n            self.postMessage({\n                type: \"execution_result\",\n                success: true,\n                returnValue,\n            } satisfies ChildMessageExecutionResultSuccess);\n        }\n        catch (error) {\n            self.postMessage({\n                type: \"execution_result\",\n                success: false,\n                error,\n            } satisfies ChildMessageExecutionResultError);\n        }\n        state = \"idling\";\n    }\n    \n    async function executeParentCodeAsync(data: ParentMessageExecutionAsync) {\n        state = \"working\";\n        const callback = eval(`(${data.functionCode})`) as (...args: any[]) => Promise<any>;\n        const args = data.args;\n\n        callback(...args)\n            .then(returnValue => {\n                self.postMessage({\n                    type: \"execution_result\",\n                    success: true,\n                    returnValue,\n                } satisfies ChildMessageExecutionResultSuccess);\n                state = \"idling\";\n            })\n            .catch(error => {\n                self.postMessage({\n                    type: \"execution_result\",\n                    success: false,\n                    error,\n                } satisfies ChildMessageExecutionResultError);\n                state = \"idling\";\n            });\n    }\n    \n    self.addEventListener(\"message\", (ev) => {\n        const data = ev.data as ParentMessage;\n\n        switch (data.type) {\n        case \"status\":\n            const respond: ChildMessageStatus = {\n                type: \"status\",\n                status: state\n            };\n\n            self.postMessage(respond);\n            break;\n        case \"resume\":\n            state = \"idling\";\n            break;\n        }\n\n        if (state == \"suspended\") return;\n\n        switch (data.type) {\n        case \"execute\":\n            executeParentCode(data);\n            break;\n        case \"execute_async\":\n            if (data.shouldAwait) {\n                executeParentCodeAsync(data);\n            }\n            else {\n                executeParentCode(data);\n            }\n            break;\n        case \"suspend\":\n            state = \"suspended\";\n            break;\n        case \"shutdown\":\n            state = \"shutdown\";\n            self.postMessage({ type: \"status\", status: \"shutdown\" } satisfies ChildMessageStatus);\n            self.close();\n            break;\n        }\n    });\n}\n\n/**\n * WorkerJQ is a queue-based wrapper around {@link Worker} from Web Worker API.\n * \n * Developer can queue multiple jobs to WorkerJQ, then the class will manage its job by executing the last job on the queue, then waiting into the next one.\n */\nexport class WorkerJQ extends EventTarget {\n    static readonly scriptUrl = `data:text/javascript;charset=utf-8,(${workerLoop.toString()}).call(this)`;\n\n    #jobQueue: Job<any>[] = [];\n    #currentlyExecutingJob: Job<any> | null = null;\n    #worker: Worker;\n    #state: \"idling\" | \"working\" | \"suspended\" | \"shutdown\" | \"terminated\" | \"error\" = \"idling\";\n\n    constructor ({ url }: Partial<WorkerJQOptions> = {}) {\n        super();\n\n        this.#worker = new Worker(url ?? WorkerJQ.scriptUrl);\n\n        this.work();\n    }\n\n    get worker() {\n        return this.#worker;\n    }\n\n    set worker(worker: Worker) {\n        this.reinit(worker);\n    }\n\n    get state() {\n        return this.#state;\n    }\n\n    work() {\n        if (this.#state == \"idling\" && this.#jobQueue.length > 0) {\n            this.#state = \"working\";\n            const job = this.#currentlyExecutingJob = this.#jobQueue.pop()!;\n\n            this.execute(job).then(result => {\n                this.#state = \"idling\";\n                this.#currentlyExecutingJob = null;\n                const event = new JobDoneEvent({ job, result });\n                this.dispatchEvent(event);\n                this.work();\n            });\n        }\n    }\n\n    clearQueue() {\n        this.#jobQueue.length = 0;\n    }\n\n    reinit(worker?: Worker) {\n        worker ??= new Worker(WorkerJQ.scriptUrl);\n        this.terminate();\n        this.#state = \"idling\";\n        this.#worker = worker;\n        this.work();\n    }\n\n    terminate() {\n        this.#worker.terminate();\n    }\n\n    async restart(worker?: Worker) {\n        worker ??= new Worker(WorkerJQ.scriptUrl);\n        await this.shutdown();\n        this.#state = \"idling\";\n        this.#worker = worker;\n        this.work();\n    }\n\n    async shutdown() {\n        this.#worker.postMessage({\n            type: \"shutdown\"\n        } satisfies ParentMessageClose);\n\n        return this.awaitMessage({ type: \"status\", test: (message) => message.status == \"shutdown\" }).then(result => {\n            this.#state = \"shutdown\";\n            return result;\n        });\n    }\n\n    async suspend() {\n        this.#worker.postMessage({\n            type: \"suspend\"\n        } satisfies ParentMessageSuspend);\n\n        this.#state = \"suspended\";\n    }\n\n    async resume() {\n        this.#worker.postMessage({\n            type: \"resume\"\n        } satisfies ParentMessageResume);\n\n        this.#state = \"idling\";\n        this.work();\n    }\n\n    async execute<Result>(job: Job<Result>): Promise<Result> {\n        const data: ParentMessageExecution = {\n            type: \"execute\",\n            functionCode: job.callback.toString(),\n            args: job.args\n        };\n\n        this.#worker.postMessage(data);\n\n        const messageExecutionResult = await this.awaitMessage<\"execution_result\">({ type: \"execution_result\" });\n\n        if (messageExecutionResult.success) {\n            return messageExecutionResult.returnValue;\n        }\n        else {\n            throw new WorkerScriptError(this, messageExecutionResult.error);\n        }\n    }\n\n    async run<Result, Args extends any[]>(callback: (...args: Args) => Result, args?: Args): Promise<Result> {\n        const job = this.queue(callback, args);\n        return this.awaitJobDone(job);\n    }\n\n    queue<Result, Args extends any[]>(callback: (...args: Args) => Result, args?: Args): Readonly<Job<Result, Args>> {\n        if (!(this.#state == \"idling\" || this.#state == \"working\")) throw new WorkerDeadState(this, this.#state);\n\n        const job: Job<Result, Args> = {\n            callback,\n            // @ts-ignore\n            args: args ?? [] as any[],\n        };\n\n        this.#jobQueue.push(job);\n\n        this.work();\n\n        return job;\n    }\n\n    remove(job: Job<any>) {\n        const jobIndex = this.#jobQueue.indexOf(job);\n\n        if (jobIndex == -1) {\n            return false;\n        }\n        else {\n            this.#jobQueue.splice(jobIndex, 1);\n            return true;\n        }\n    }\n\n    awaitMessage<Type extends ChildMessage[\"type\"]>(options: { type: Type } & Partial<AwaitMessageInit<Extract<ChildMessage, { type: Type }>>>): Promise<Extract<ChildMessage, { type: Type }>>;\n    awaitMessage<Message extends ChildMessage>({ type, test, timeout = 50_000 }: Partial<AwaitMessageInit> = {}): Promise<Message> {\n        return new Promise(resolve => {\n            let timeoutId: NodeJS.Timeout;\n\n            this.#worker.addEventListener(\"message\", (ev) => {\n                const childMessage: ChildMessage = ev.data;\n                if (type) {\n                    if (childMessage.type != type) {\n                        return;\n                    }\n                }\n                if (test) {\n                    if (!test(childMessage)) {\n                        return;\n                    }\n                }\n                if (timeoutId) clearTimeout(timeoutId);\n                resolve(childMessage as Message);\n            });\n\n            if (typeof timeout == \"number\") {\n                timeoutId = setTimeout(() => {\n                    throw new WorkerUnreponsiveError(this);\n                }, timeout);\n            }\n        });\n    }\n\n    awaitJobDone<Result>(job: Job<Result>): Promise<Result> {\n        if (!this.#jobQueue.includes(job) && this.#currentlyExecutingJob != job) throw new JobNotFound(this, job);\n\n        return new Promise(resolve => {\n            this.addEventListener(\"job-done\", (ev) => {\n                const event = ev as JobDoneEvent;\n                if (event.job == job) {\n                    resolve(event.result);\n                }\n            });\n        })\n    }\n}","\n/**\n * Configuration used for {@link observeMutation} and {@link MutationObserver}.\n */\nexport interface ObserveMutationOptions extends MutationObserverInit {\n    /**\n     * Target node for mutation observer. This will be used for `MutationObserver.observe`.\n     */\n    target: Node;\n    /**\n     * Abort signal used for disconnecting mutation observer.\n     * \n     * If abort signal is aborted, then mutation observer is disconnected.\n     */\n    abortSignal?: AbortSignal;\n    /**\n     * This will make mutation observer disconnect after detecting mutation once.\n     */\n    once?: boolean;\n}\n\nexport type ObserveMutationCallback = (info: { records: MutationRecord[], observer: MutationObserver }) => void;\n\n/**\n* Create a new `MutationObserver` with options and callback.\n* @param {ObserveMutationOptions} options \n* @param {ObserveMutationCallback} callback \n* @returns {MutationObserver}\n*/\nexport function observeMutation({ target, abortSignal, once, ...options }: ObserveMutationOptions, callback: ObserveMutationCallback): MutationObserver {\n   const observer = new MutationObserver(records => {\n        if (once) observer.disconnect();\n        callback({ records, observer });\n   });\n\n   observer.observe(target, options);\n\n   abortSignal?.addEventListener(\"abort\", () => {\n       observer.disconnect();\n   });\n\n   return observer;\n}\n\n/**\n* Create a new `MutationObserver` that only executes once.\n* @param {ObserveMutationOptions} options \n* @param {ObserveMutationCallback} callback \n* @returns {MutationObserver}\n*/\nexport function observeMutationOnce(options: ObserveMutationOptions, callback: ObserveMutationCallback): MutationObserver {\n    return observeMutation({ once: true, ...options }, callback);\n}\n\n/**\n* Create a new `MutationObserver` asyncronously that only executes once.\n* @param {ObserveMutationOptions} options \n* @param {ObserveMutationCallback} callback \n* @returns {MutationObserver}\n*/\nexport function observeMutationAsync({ target, abortSignal, ...options }: ObserveMutationOptions, callback: ObserveMutationCallback): Promise<{ records: MutationRecord[], observer: MutationObserver }> {\n    return new Promise(resolve => {\n        const observer = new MutationObserver(records => {\n            observer.disconnect();\n            resolve({ records, observer });\n        });\n\n        observer.observe(target, options);\n\n        abortSignal?.addEventListener(\"abort\", () => {\n            observer.disconnect();\n        });\n    });\n}\n\nexport const makeMutationObserver = observeMutation;","\nexport class WaitForElementTimeoutError extends Error {\n    name = this.constructor.name;\n\n    constructor (ms: number) {\n        super(`wait for element timeout for ${ms}ms`);\n    }\n}\n\nexport class WaitForElementMaxTriesError extends Error {\n    name = this.constructor.name;\n\n    constructor (maxTries: number) {\n        super(`wait for element out of tries (max tries: ${maxTries})`);\n    }\n}\n\nexport class WaitForElementMissingOptionError extends Error {\n    name = this.constructor.name;\n}","\nimport { WaitForElementMissingOptionError, WaitForElementMaxTriesError, WaitForElementTimeoutError } from \"./wait-for-element-errors\";\nimport { observeMutation } from \"./mutation-observer\";\n\nexport type QueryOptions<QueryFnResult, QueryFn extends (selector: string) => QueryFnResult | null = (selector: string) => QueryFnResult | null> =\n    ({ id: string } | { selector: string })\n    & {\n        parent?: ParentNode;\n        querySelector?: QueryFn;\n        abortSignal?: AbortSignal;\n        timeout?: number | false;\n        maxTries?: number;\n        ensureDomContentLoaded?: boolean;\n        observerOptions?: MutationObserverInit;\n    };\n\nexport async function executeQuery\n    <QueryFnResult, QueryFn extends (selector: string) => QueryFnResult | null = (selector: string) => QueryFnResult | null>\n    (options: QueryOptions<QueryFnResult, QueryFn>): Promise<QueryFnResult>\n{\n    let selector: string;\n    const parent = options.parent ?? document.body;\n    const querySelector: QueryFn = options.querySelector ?? document.querySelector as QueryFn;\n    const maxTries = options.maxTries ?? Infinity;\n    const timeout = options.timeout ?? 10_000;\n\n    if (\"id\" in options) {\n        selector = `#${options.id}`;\n    }\n    else if (\"selector\" in options) {\n        selector = options.selector;\n    }\n    else {\n        throw new WaitForElementMissingOptionError(`missing options \"id\" or \"selector\"`);\n    }\n\n    let result: QueryFnResult | null = querySelector(selector);\n\n    if (result) return result;\n\n    let tries = 0;\n\n    const abortController = new AbortController;\n    const abortSignal: AbortSignal = abortController.signal;\n\n    options.abortSignal?.addEventListener(\"abort\", () => abortController.abort());\n\n    return new Promise((resolve, reject) => {\n        const mutation = observeMutation({ target: parent, abortSignal, childList: true, subtree: true, ...options.observerOptions }, () => {\n            result = querySelector(selector);\n            if (result != null) {\n                resolve(result);\n                mutation.disconnect();\n            }\n            else if (tries > maxTries) {\n                mutation.disconnect();\n                reject(new WaitForElementMaxTriesError(maxTries));\n            }\n            tries++;\n        });\n\n        if (timeout != false && timeout != Infinity) {\n            setTimeout(() => {\n                mutation.disconnect();\n                reject(new WaitForElementTimeoutError(timeout));\n            }, timeout);\n        }\n    });\n}\n\nexport function waitForElement<Elem extends Element>(selector: string, options: QueryOptions<Elem>): Promise<Elem> {\n    return executeQuery({ selector, ...options });\n}\n\nexport function waitForElementAll(selector: string, options: QueryOptions<NodeListOf<Element>>): Promise<Element[]> {\n    return executeQuery<NodeListOf<Element>>({ selector, ...options }).then(i => Array.from(i));\n}\n\nexport function waitForElementParent<Elem extends Element>(parent: ParentNode, selector: string, options: QueryOptions<Elem>): Promise<Elem> {\n    return executeQuery({ selector, parent, ...options });\n}\n\nexport function waitForElementId<Elem extends Element>(id: string, options: QueryOptions<Elem>): Promise<Elem> {\n    return executeQuery<Elem>({ id, ...options });\n}\n\nexport function waitForElementInf<Elem extends Element>(selector: string, options: QueryOptions<Elem>): Promise<Elem> {\n    return executeQuery({ selector, timeout: Infinity, ...options });\n}"],"names":["text","s","template","subst","completeString","i","elem","dict","substRegex","_","varKey","_a","worker","__publicField","error","state","job","result","options","returnValue","ev","data","respond","_jobQueue","_currentlyExecutingJob","_worker","_state","_WorkerJQ","url","__privateAdd","__privateSet","__privateGet","event","message","messageExecutionResult","callback","args","jobIndex","type","test","timeout","resolve","timeoutId","childMessage","target","abortSignal","once","observer","records","ms","maxTries","selector","parent","querySelector","tries","abortController","reject","mutation","id"],"mappings":"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"}