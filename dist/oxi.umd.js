(function(c,u){typeof exports=="object"&&typeof module<"u"?u(exports):typeof define=="function"&&define.amd?define(["exports"],u):(c=typeof globalThis<"u"?globalThis:c||self,u(c.oxi={}))})(this,function(exports){var c,u,l,p,x,T,M,L,R,F;"use strict";var I=Object.defineProperty;var D=(c,u,l)=>u in c?I(c,u,{enumerable:!0,configurable:!0,writable:!0,value:l}):c[u]=l;var d=(c,u,l)=>(D(c,typeof u!="symbol"?u+"":u,l),l),A=(c,u,l)=>{if(!u.has(c))throw TypeError("Cannot "+l)};var i=(c,u,l)=>(A(c,u,"read from private field"),l?l.call(c):u.get(c)),k=(c,u,l)=>{if(u.has(c))throw TypeError("Cannot add the same private member more than once");u instanceof WeakSet?u.add(c):u.set(c,l)},m=(c,u,l,p)=>(A(c,u,"write to private field"),p?p.call(c,l):u.set(c,l),l);const HTMLEntityMap={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"};function escapeHTML(r){return r.replace(/[&<>"'`=\/]/g,t=>HTMLEntityMap[t])}function html(r,...t){const e=[];for(let n=0;n<r.length;n++)e.push(r[n]),t[n]&&e.push(escapeHTML(String(t[n])));return fromHTML(e.join(""))}function fromHTML(r){const t=document.createElement("div");return t.innerHTML=r,setTimeout(()=>t.remove()),t.children[0]}function escapeRegExp(r){return r.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function formatString(r,t,{subst:e={format:"${{ | }}",var:"|"}}={}){const n=e.format.split(e.var).map(escapeRegExp).join(String.raw`([$\w\d-_.: ]+)`);return r.replace(new RegExp(n,"g"),(s,a)=>{var o;return(o=t[a])==null?void 0:o.toString()})}class TaskerUnreponsiveError extends Error{constructor(e){super("worker is unresponsive");d(this,"name",this.constructor.name);d(this,"tasker");this.tasker=e}}class TaskerScriptError extends Error{constructor(e,n){super(`script error caused by worker (${n.name})`);d(this,"name",this.constructor.name);d(this,"tasker");this.tasker=e,this.cause=n}}class TaskerDeadState extends Error{constructor(e,n){super(`worker is in dead state (${n})`);d(this,"name",this.constructor.name);d(this,"tasker");this.tasker=e}}class TaskNotFound extends Error{constructor(e,n){super("job not found in worker");d(this,"name",this.constructor.name);d(this,"tasker");d(this,"task");this.tasker=e,this.task=n}}class TaskFulfilledEvent extends Event{constructor({task:e,result:n},s){super("task_fulfilled",s);d(this,"task");d(this,"result");this.task=e,this.result=n}}class TaskErrorEvent extends Event{constructor({task:e,error:n},s){super("task_error",s);d(this,"task");d(this,"error");this.task=e,this.error=n}}function workerLoop(){let state="idling";function runTask(data){state="working";const callback=eval(`(${data.callbackCode})`),args=data.args;try{const r=callback(...args);r instanceof Promise?r.then(t=>{self.postMessage({type:"task_fulfilled",returnValue:t})}).catch(t=>{self.postMessage({type:"task_error",error:t})}):self.postMessage({type:"task_fulfilled",returnValue:r})}catch(r){self.postMessage({type:"task_error",error:r})}state="idling"}self.addEventListener("message",r=>{const t=r.data;switch(t.type){case"status":self.postMessage({type:"status",status:state});break;case"resume":state="idling";break}if(state!="suspended")switch(t.type){case"task_execute":runTask(t);break;case"suspend":state="suspended";break;case"shutdown":state="shutdown",self.postMessage({type:"status",status:"shutdown"}),self.close();break}})}const b=class extends EventTarget{constructor({url:e}={}){super();k(this,c,[]);k(this,u,null);k(this,l,void 0);k(this,p,"idling");m(this,l,new Worker(e??b.scriptUrl)),this.work()}static createTask(e,n){return{callback:e,args:n??[]}}get worker(){return i(this,l)}set worker(e){this.reinit(e)}get status(){return i(this,p)}work(){if(i(this,p)=="idling"&&i(this,c).length>0){m(this,p,"working");const e=m(this,u,i(this,c).pop()),n=()=>{m(this,p,"idling"),m(this,u,null),this.work()};this.execute(e).then(n).catch(n)}}terminate(){i(this,l).terminate(),m(this,p,"terminated")}reinit(e){e??(e=new Worker(b.scriptUrl)),this.terminate(),m(this,p,"idling"),m(this,l,e),this.work()}async shutdown(){return i(this,l).postMessage({type:"shutdown"}),this.awaitMessage({type:"status",test:e=>e.status=="shutdown"}).then(e=>(m(this,p,"shutdown"),e))}async restart(e){e??(e=new Worker(b.scriptUrl)),await this.shutdown(),m(this,p,"idling"),m(this,l,e),this.work()}async suspend(){return i(this,l).postMessage({type:"suspend"}),m(this,p,"suspended"),this.awaitMessage({type:"status",test:e=>e.status=="suspended"})}async resume(){return i(this,l).postMessage({type:"resume"}),this.awaitMessage({type:"status",test:e=>e.status=="idling"}).then(e=>(m(this,p,"idling"),this.work(),e))}async execute(e){const n={type:"task_execute",callbackCode:e.callback.toString(),args:e.args};i(this,l).postMessage(n);const s=await this.awaitMessage({test:a=>a.type=="task_fulfilled"||a.type=="task_error"});if(s.type=="task_fulfilled"){const a=new TaskFulfilledEvent({task:e,result:s.returnValue});return this.dispatchEvent(a),s.returnValue}else{const a=new TaskerScriptError(this,s.error),o=new TaskErrorEvent({task:e,error:a});throw this.dispatchEvent(o),a}}async run(e,n){const s=this.queue(e,n);return this.awaitTask(s)}queue(e,n){if(!(i(this,p)=="idling"||i(this,p)=="working"))throw new TaskerDeadState(this,i(this,p));let s;return typeof e=="function"?s=b.createTask(e,n):s=e,i(this,c).push(s),this.work(),s}remove(e){const n=i(this,c).indexOf(e);if(n==-1)throw new TaskNotFound(this,e);return i(this,c).splice(n,1),!0}clearQueue(){i(this,c).length=0}awaitMessage({type:e,test:n,timeout:s=5e4}={}){return new Promise(a=>{let o;i(this,l).addEventListener("message",h=>{const f=h.data;e&&(Array.isArray(e)&&!e.includes(f.type)||f.type!=e)||n&&!n(f)||(o&&clearTimeout(o),a(f))},{once:!0}),typeof s=="number"&&(o=setTimeout(()=>{throw new TaskerUnreponsiveError(this)},s))})}awaitTask(e){if(!i(this,c).includes(e)&&i(this,u)!=e)throw new TaskNotFound(this,e);return new Promise((n,s)=>{this.addEventListener("task_fulfilled",a=>{const o=a;o.task==e&&n(o.result)},{once:!0}),this.addEventListener("task_error",a=>{const o=a;o.task==e&&s(o.error)},{once:!0})})}};let Tasker=b;c=new WeakMap,u=new WeakMap,l=new WeakMap,p=new WeakMap,d(Tasker,"scriptUrl",`data:text/javascript;charset=utf-8,(${workerLoop.toString()}).call(this)`);function observeMutation({target:r,abortSignal:t,once:e,...n},s){const a=new MutationObserver(o=>{e&&a.disconnect(),s({records:o,observer:a})});return a.observe(r,n),t==null||t.addEventListener("abort",()=>{a.disconnect()}),a}function observeMutationOnce(r,t){return observeMutation({once:!0,...r},t)}function observeMutationAsync({target:r,abortSignal:t,...e},n){return new Promise(s=>{const a=new MutationObserver(o=>{a.disconnect(),s({records:o,observer:a})});a.observe(r,e),t==null||t.addEventListener("abort",()=>{a.disconnect()})})}const makeMutationObserver=observeMutation;class WaitForElementTimeoutError extends Error{constructor(e){super(`wait for element timeout for ${e}ms`);d(this,"name",this.constructor.name)}}class WaitForElementMaxTriesError extends Error{constructor(e){super(`wait for element out of tries (max tries: ${e})`);d(this,"name",this.constructor.name)}}class WaitForElementMissingOptionError extends Error{constructor(){super(...arguments);d(this,"name",this.constructor.name)}}async function awaitDomContentLoaded(){return new Promise(r=>{if(document.readyState!="loading")return r();document.addEventListener("DOMContentLoaded",()=>r())})}function isNotEmpty(r){return r instanceof NodeList&&r.length>0?!0:r!=null}async function executeQuery(r){var v;let t;const e=r.parent??document.body,n=r.querySelector??((g,y)=>g.querySelector(y)),s=r.maxTries??1/0,a=r.timeout??1e4;if((r.ensureDomContentLoaded??!0)&&await awaitDomContentLoaded(),"id"in r)t=`#${r.id}`;else if("selector"in r)t=r.selector;else throw new WaitForElementMissingOptionError('missing options "id" or "selector"');let h=n(e,t);if(isNotEmpty(h))return h;let f=0;const P=new AbortController,w=P.signal;return(v=r.abortSignal)==null||v.addEventListener("abort",()=>P.abort()),new Promise((g,y)=>{const E=observeMutation({target:e,abortSignal:w,childList:!0,subtree:!0,...r.observerOptions},()=>{h=n(e,t),isNotEmpty(h)?(E.disconnect(),g(h)):f>s&&(E.disconnect(),y(new WaitForElementMaxTriesError(s))),f++});a!=!1&&a!=1/0&&setTimeout(()=>{E.disconnect(),y(new WaitForElementTimeoutError(a))},a)})}function waitForElement(r,t,e){let n;return t instanceof Node&&"children"in t?n={selector:r,parent:t,...e}:n={selector:r,...t},executeQuery({selector:r,...n})}function waitForElementAll(r,t){return executeQuery({selector:r,...t}).then(e=>Array.from(e))}function waitForElementParent(r,t,e){return executeQuery({selector:t,parent:r,...e})}function waitForElementId(r,t){return executeQuery({id:r,...t})}function waitForElementInf(r,t){return executeQuery({selector:r,timeout:1/0,...t})}const DATA_URL_DEFAULT_MIME_TYPE="text/plain",DATA_URL_DEFAULT_CHARSET="us-ascii",testParameter=(r,t)=>t.some(e=>e instanceof RegExp?e.test(r):e===r),supportedProtocols=new Set(["https:","http:","file:"]),hasCustomProtocol=r=>{try{const{protocol:t}=new URL(r);return t.endsWith(":")&&!supportedProtocols.has(t)}catch{return!1}},normalizeDataURL=(r,{stripHash:t})=>{var v;const e=/^data:(?<type>[^,]*?),(?<data>[^#]*?)(?:#(?<hash>.*))?$/.exec(r);if(!e)throw new Error(`Invalid URL: ${r}`);let{type:n,data:s,hash:a}=e.groups;const o=n.split(";");a=t?"":a;let h=!1;o[o.length-1]==="base64"&&(o.pop(),h=!0);const f=((v=o.shift())==null?void 0:v.toLowerCase())??"",w=[...o.map(g=>{let[y,E=""]=g.split("=").map(U=>U.trim());return y==="charset"&&(E=E.toLowerCase(),E===DATA_URL_DEFAULT_CHARSET)?"":`${y}${E?`=${E}`:""}`}).filter(Boolean)];return h&&w.push("base64"),(w.length>0||f&&f!==DATA_URL_DEFAULT_MIME_TYPE)&&w.unshift(f),`data:${w.join(";")},${h?s.trim():s}${a?`#${a}`:""}`};function normalizeUrl(r,t){if(t={defaultProtocol:"http",normalizeProtocol:!0,forceHttp:!1,forceHttps:!1,stripAuthentication:!0,stripHash:!1,stripTextFragment:!0,stripWWW:!0,removeQueryParameters:[/^utm_\w+/i],removeTrailingSlash:!0,removeSingleSlash:!0,removeDirectoryIndex:!1,removeExplicitPort:!1,sortQueryParameters:!0,...t},typeof t.defaultProtocol=="string"&&!t.defaultProtocol.endsWith(":")&&(t.defaultProtocol=`${t.defaultProtocol}:`),r=r.trim(),/^data:/i.test(r))return normalizeDataURL(r,t);if(hasCustomProtocol(r))return r;const e=r.startsWith("//");!e&&/^\.*\//.test(r)||(r=r.replace(/^(?!(?:\w+:)?\/\/)|^\/\//,t.defaultProtocol));const s=new URL(r);if(t.forceHttp&&t.forceHttps)throw new Error("The `forceHttp` and `forceHttps` options cannot be used together");if(t.forceHttp&&s.protocol==="https:"&&(s.protocol="http:"),t.forceHttps&&s.protocol==="http:"&&(s.protocol="https:"),t.stripAuthentication&&(s.username="",s.password=""),t.stripHash?s.hash="":t.stripTextFragment&&(s.hash=s.hash.replace(/#?:~:text.*?$/i,"")),s.pathname){const o=/\b[a-z][a-z\d+\-.]{1,50}:\/\//g;let h=0,f="";for(;;){const w=o.exec(s.pathname);if(!w)break;const v=w[0],g=w.index,y=s.pathname.slice(h,g);f+=y.replace(/\/{2,}/g,"/"),f+=v,h=g+v.length}const P=s.pathname.slice(h,s.pathname.length);f+=P.replace(/\/{2,}/g,"/"),s.pathname=f}if(s.pathname)try{s.pathname=decodeURI(s.pathname)}catch{}if(t.removeDirectoryIndex===!0&&(t.removeDirectoryIndex=[/^index\.[a-z]+$/]),Array.isArray(t.removeDirectoryIndex)&&t.removeDirectoryIndex.length>0){let o=s.pathname.split("/");const h=o[o.length-1];testParameter(h,t.removeDirectoryIndex)&&(o=o.slice(0,-1),s.pathname=o.slice(1).join("/")+"/")}if(s.hostname&&(s.hostname=s.hostname.replace(/\.$/,""),t.stripWWW&&/^www\.(?!www\.)[a-z\-\d]{1,63}\.[a-z.\-\d]{2,63}$/.test(s.hostname)&&(s.hostname=s.hostname.replace(/^www\./,""))),Array.isArray(t.removeQueryParameters))for(const o of[...s.searchParams.keys()])testParameter(o,t.removeQueryParameters)&&s.searchParams.delete(o);if(!Array.isArray(t.keepQueryParameters)&&t.removeQueryParameters===!0&&(s.search=""),Array.isArray(t.keepQueryParameters)&&t.keepQueryParameters.length>0)for(const o of[...s.searchParams.keys()])testParameter(o,t.keepQueryParameters)||s.searchParams.delete(o);if(t.sortQueryParameters){s.searchParams.sort();try{s.search=decodeURIComponent(s.search)}catch{}}t.removeTrailingSlash&&(s.pathname=s.pathname.replace(/\/$/,"")),t.removeExplicitPort&&s.port&&(s.port="");const a=r;return r=s.toString(),!t.removeSingleSlash&&s.pathname==="/"&&!a.endsWith("/")&&s.hash===""&&(r=r.replace(/\/$/,"")),(t.removeTrailingSlash||s.pathname==="/")&&s.hash===""&&t.removeSingleSlash&&(r=r.replace(/\/$/,"")),e&&!t.normalizeProtocol&&(r=r.replace(/^http:\/\//,"//")),t.stripProtocol&&(r=r.replace(/^(?:https?:)?\/\//,"")),r}function urlMatches(r,t){let e=!1;return t==null?!1:r===!0?!0:(t=normalizeUrl(t),r instanceof URL&&(e=normalizeUrl(r.href)==t),typeof r=="string"&&(e=normalizeUrl(r)==t),r instanceof RegExp&&(e=r.test(t)),e)}function headersMatches(r,t){let e=!1;if(Object.keys(r).length==0)return!0;for(const s of Object.keys(r)){const a=r[s],o=t.get(s);if(o==null)return!1;if(a===!0)return!0;if(a instanceof URL?e=normalizeUrl(a.href)==normalizeUrl(o):a instanceof RegExp?e=a.test(o):e=String(a)==o,!e)return!1}return e}function fetchInterceptorFactory(r,t){return async function(n,s){const a=new Request(n,s),o=r.interceptRequest(a);return o.blocked?Response.error():t(o).then(h=>r.interceptResponse(h))}}class NetworkInterceptor{constructor({global:t=globalThis,fetchKey:e="fetch",xmlHttpRequestKey:n="XMLHttpRequest"}={}){k(this,x,[]);k(this,T,[]);k(this,M,void 0);k(this,L,void 0);k(this,R,void 0);k(this,F,void 0);m(this,M,t[e]),m(this,L,t[e]=fetchInterceptorFactory(this,i(this,M))),m(this,R,t[n]),m(this,F,t[n])}get windowFetch(){return i(this,M)}get patchedFetch(){return i(this,L)}interceptRequest(t){let e=t;e.blocked=!1;for(const n of i(this,x))if(urlMatches(n.url,e.url)&&headersMatches(n.headers,e.headers)){if(n.block){e.blocked=!0;break}if(n.redirect&&(e=new Request(n.redirect,e),e.blocked=!1),n.callback(e),e.blocked)break}return e}interceptResponse(t){const e=t;for(const n of i(this,T))urlMatches(n.url,e.url)&&headersMatches(n.headers,e.headers)&&n.callback(e);return e}addRule(t,e,n,s){let a;if(t.constructor==Object){if(a=t,!a.type)throw new TypeError("missing type option");if(!a.callback)throw new TypeError("missing callback option")}else a={type:t,url:e,callback:n,...s};return a.headers??(a.headers={}),a.type=="request"?i(this,x).push(a):a.type=="response"&&i(this,T).push(a),a}removeRule(t){if(t.type=="request"){const e=i(this,x).findIndex(n=>n==t);i(this,x).splice(e,1)}else{const e=i(this,T).findIndex(n=>n==t);i(this,T).splice(e,1)}}clearRules(){i(this,x).length=0,i(this,T).length=0}patchFetch(){window.fetch=i(this,L)}restoreFetch(){window.fetch=i(this,M)}}x=new WeakMap,T=new WeakMap,M=new WeakMap,L=new WeakMap,R=new WeakMap,F=new WeakMap,exports.HTMLEntityMap=HTMLEntityMap,exports.NetworkInterceptor=NetworkInterceptor,exports.TaskErrorEvent=TaskErrorEvent,exports.TaskFulfilledEvent=TaskFulfilledEvent,exports.TaskNotFound=TaskNotFound,exports.Tasker=Tasker,exports.TaskerDeadState=TaskerDeadState,exports.TaskerScriptError=TaskerScriptError,exports.TaskerUnreponsiveError=TaskerUnreponsiveError,exports.awaitDomContentLoaded=awaitDomContentLoaded,exports.escapeHTML=escapeHTML,exports.escapeRegExp=escapeRegExp,exports.executeQuery=executeQuery,exports.formatString=formatString,exports.fromHTML=fromHTML,exports.headersMatches=headersMatches,exports.html=html,exports.makeMutationObserver=makeMutationObserver,exports.observeMutation=observeMutation,exports.observeMutationAsync=observeMutationAsync,exports.observeMutationOnce=observeMutationOnce,exports.urlMatches=urlMatches,exports.waitForElement=waitForElement,exports.waitForElementAll=waitForElementAll,exports.waitForElementId=waitForElementId,exports.waitForElementInf=waitForElementInf,exports.waitForElementParent=waitForElementParent,Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"})});
//# sourceMappingURL=oxi.umd.js.map
