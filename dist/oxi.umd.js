(function(c,u){typeof exports=="object"&&typeof module<"u"?u(exports):typeof define=="function"&&define.amd?define(["exports"],u):(c=typeof globalThis<"u"?globalThis:c||self,u(c.oxi={}))})(this,function(exports){var c,u,l,p,b,k,M,L,R,F;"use strict";var W=Object.defineProperty;var I=(c,u,l)=>u in c?W(c,u,{enumerable:!0,configurable:!0,writable:!0,value:l}):c[u]=l;var m=(c,u,l)=>(I(c,typeof u!="symbol"?u+"":u,l),l),A=(c,u,l)=>{if(!u.has(c))throw TypeError("Cannot "+l)};var i=(c,u,l)=>(A(c,u,"read from private field"),l?l.call(c):u.get(c)),w=(c,u,l)=>{if(u.has(c))throw TypeError("Cannot add the same private member more than once");u instanceof WeakSet?u.add(c):u.set(c,l)},f=(c,u,l,p)=>(A(c,u,"write to private field"),p?p.call(c,l):u.set(c,l),l);const HTMLEntityMap={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"};function escapeHTML(r){return r.replace(/[&<>"'`=\/]/g,t=>HTMLEntityMap[t])}function html(r,...t){const e=[];for(let o=0;o<r.length;o++)e.push(r[o]),t[o]&&e.push(escapeHTML(String(t[o])));return fromHTML(e.join(""))}function fromHTML(r){const t=document.createElement("div");return t.innerHTML=r,setTimeout(()=>t.remove()),t.children[0]}function escapeRegExp(r){return r.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function formatString(r,t,{subst:e={format:"${{ | }}",var:"|"}}={}){const o=e.format.split(e.var).map(escapeRegExp).join(String.raw`([$\w\d-_.: ]+)`);return r.replace(new RegExp(o,"g"),(s,n)=>{var a;return(a=t[n])==null?void 0:a.toString()})}class WorkerUnreponsiveError extends Error{constructor(e){super("worker is unresponsive");m(this,"name",this.constructor.name);m(this,"worker");this.worker=e}}class WorkerScriptError extends Error{constructor(e,o){super(`script error caused by worker (${o.name})`);m(this,"name",this.constructor.name);m(this,"worker");this.worker=e,this.cause=o}}class WorkerDeadState extends Error{constructor(e,o){super(`worker is in dead state (${o})`);m(this,"name",this.constructor.name);m(this,"worker");this.worker=e}}class JobNotFound extends Error{constructor(e,o){super("job not found in worker");m(this,"name",this.constructor.name);m(this,"worker");m(this,"job");this.worker=e,this.job=o}}class JobFinishedEvent extends Event{constructor({job:e,result:o},s){super("job-finished",s);m(this,"job");m(this,"result");this.job=e,this.result=o}}class JobErrorEvent extends Event{constructor({job:e,error:o},s){super("job-error",s);m(this,"job");m(this,"error");this.job=e,this.error=o}}function workerLoop(){let state="idling";function executeParentCode(data){state="working";const callback=eval(`(${data.functionCode})`),args=data.args;try{const r=callback(...args);self.postMessage({type:"execution_result",success:!0,returnValue:r})}catch(r){self.postMessage({type:"execution_result",success:!1,error:r})}state="idling"}async function executeParentCodeAsync(data){state="working";const callback=eval(`(${data.functionCode})`),args=data.args;callback(...args).then(r=>{self.postMessage({type:"execution_result",success:!0,returnValue:r}),state="idling"}).catch(r=>{self.postMessage({type:"execution_result",success:!1,error:r}),state="idling"})}self.addEventListener("message",r=>{const t=r.data;switch(t.type){case"status":self.postMessage({type:"status",status:state});break;case"resume":state="idling";break}if(state!="suspended")switch(t.type){case"execute":executeParentCode(t);break;case"execute_async":t.shouldAwait?executeParentCodeAsync(t):executeParentCode(t);break;case"suspend":state="suspended";break;case"shutdown":state="shutdown",self.postMessage({type:"status",status:"shutdown"}),self.close();break}})}const P=class extends EventTarget{constructor({url:e}={}){super();w(this,c,[]);w(this,u,null);w(this,l,void 0);w(this,p,"idling");m(this,"awaitJobDone",this.awaitJob);f(this,l,new Worker(e??P.scriptUrl)),this.work()}static createJob(e,o){return{callback:e,args:o??[]}}get worker(){return i(this,l)}set worker(e){this.reinit(e)}get state(){return i(this,p)}work(){if(i(this,p)=="idling"&&i(this,c).length>0){f(this,p,"working");const e=f(this,u,i(this,c).pop());this.execute(e).then(o=>{f(this,p,"idling"),f(this,u,null);const s=new JobFinishedEvent({job:e,result:o});this.dispatchEvent(s),this.work()}).catch(o=>{const s=o;console.error(s),f(this,p,"idling"),f(this,u,null);const n=new JobErrorEvent({job:e,error:s.cause});this.dispatchEvent(n),this.work()})}}clearQueue(){i(this,c).length=0}reinit(e){e??(e=new Worker(P.scriptUrl)),this.terminate(),f(this,p,"idling"),f(this,l,e),this.work()}terminate(){i(this,l).terminate(),f(this,p,"terminated")}async restart(e){e??(e=new Worker(P.scriptUrl)),await this.shutdown(),f(this,p,"idling"),f(this,l,e),this.work()}async shutdown(){return i(this,l).postMessage({type:"shutdown"}),this.awaitMessage({type:"status",test:e=>e.status=="shutdown"}).then(e=>(f(this,p,"shutdown"),e))}async suspend(){return i(this,l).postMessage({type:"suspend"}),f(this,p,"suspended"),this.awaitMessage({type:"status",test:e=>e.status=="suspended"})}async resume(){return i(this,l).postMessage({type:"resume"}),this.awaitMessage({type:"status",test:e=>e.status=="idling"}).then(e=>(f(this,p,"idling"),this.work(),e))}async execute(e){const o={type:"execute",functionCode:e.callback.toString(),args:e.args};i(this,l).postMessage(o);const s=await this.awaitMessage({type:"execution_result"});if(s.success)return s.returnValue;throw new WorkerScriptError(this,s.error)}async run(e,o){const s=this.queue(e,o);return this.awaitJob(s)}queue(e,o){if(!(i(this,p)=="idling"||i(this,p)=="working"))throw new WorkerDeadState(this,i(this,p));let s;return typeof e=="function"?s=P.createJob(e,o):s=e,i(this,c).push(s),this.work(),s}remove(e){const o=i(this,c).indexOf(e);return o==-1?!1:(i(this,c).splice(o,1),!0)}awaitMessage({type:e,test:o,timeout:s=5e4}={}){return new Promise(n=>{let a;i(this,l).addEventListener("message",h=>{const d=h.data;e&&d.type!=e||o&&!o(d)||(a&&clearTimeout(a),n(d))}),typeof s=="number"&&(a=setTimeout(()=>{throw new WorkerUnreponsiveError(this)},s))})}awaitJob(e){if(!i(this,c).includes(e)&&i(this,u)!=e)throw new JobNotFound(this,e);return new Promise((o,s)=>{const n=h=>{const d=h;d.job==e&&(o(d.result),this.removeEventListener("job-finished",n))},a=h=>{const d=h;d.job==e&&(s(d.error),this.removeEventListener("job-error",n))};this.addEventListener("job-finished",n),this.addEventListener("job-error",a)})}};let WorkerJQ=P;c=new WeakMap,u=new WeakMap,l=new WeakMap,p=new WeakMap,m(WorkerJQ,"scriptUrl",`data:text/javascript;charset=utf-8,(${workerLoop.toString()}).call(this)`);function observeMutation({target:r,abortSignal:t,once:e,...o},s){const n=new MutationObserver(a=>{e&&n.disconnect(),s({records:a,observer:n})});return n.observe(r,o),t==null||t.addEventListener("abort",()=>{n.disconnect()}),n}function observeMutationOnce(r,t){return observeMutation({once:!0,...r},t)}function observeMutationAsync({target:r,abortSignal:t,...e},o){return new Promise(s=>{const n=new MutationObserver(a=>{n.disconnect(),s({records:a,observer:n})});n.observe(r,e),t==null||t.addEventListener("abort",()=>{n.disconnect()})})}const makeMutationObserver=observeMutation;class WaitForElementTimeoutError extends Error{constructor(e){super(`wait for element timeout for ${e}ms`);m(this,"name",this.constructor.name)}}class WaitForElementMaxTriesError extends Error{constructor(e){super(`wait for element out of tries (max tries: ${e})`);m(this,"name",this.constructor.name)}}class WaitForElementMissingOptionError extends Error{constructor(){super(...arguments);m(this,"name",this.constructor.name)}}async function awaitDomContentLoaded(){return new Promise(r=>{if(document.readyState!="loading")return r();document.addEventListener("DOMContentLoaded",()=>r())})}function isNotEmpty(r){return r instanceof NodeList&&r.length>0?!0:r!=null}async function executeQuery(r){var v;let t;const e=r.parent??document.body,o=r.querySelector??((g,x)=>g.querySelector(x)),s=r.maxTries??1/0,n=r.timeout??1e4;if((r.ensureDomContentLoaded??!0)&&await awaitDomContentLoaded(),"id"in r)t=`#${r.id}`;else if("selector"in r)t=r.selector;else throw new WaitForElementMissingOptionError('missing options "id" or "selector"');let h=o(e,t);if(isNotEmpty(h))return h;let d=0;const T=new AbortController,y=T.signal;return(v=r.abortSignal)==null||v.addEventListener("abort",()=>T.abort()),new Promise((g,x)=>{const E=observeMutation({target:e,abortSignal:y,childList:!0,subtree:!0,...r.observerOptions},()=>{h=o(e,t),isNotEmpty(h)?(E.disconnect(),g(h)):d>s&&(E.disconnect(),x(new WaitForElementMaxTriesError(s))),d++});n!=!1&&n!=1/0&&setTimeout(()=>{E.disconnect(),x(new WaitForElementTimeoutError(n))},n)})}function waitForElement(r,t,e){let o;return t instanceof Node&&"children"in t?o={selector:r,parent:t,...e}:o={selector:r,...t},executeQuery({selector:r,...o})}function waitForElementAll(r,t){return executeQuery({selector:r,...t}).then(e=>Array.from(e))}function waitForElementParent(r,t,e){return executeQuery({selector:t,parent:r,...e})}function waitForElementId(r,t){return executeQuery({id:r,...t})}function waitForElementInf(r,t){return executeQuery({selector:r,timeout:1/0,...t})}const DATA_URL_DEFAULT_MIME_TYPE="text/plain",DATA_URL_DEFAULT_CHARSET="us-ascii",testParameter=(r,t)=>t.some(e=>e instanceof RegExp?e.test(r):e===r),supportedProtocols=new Set(["https:","http:","file:"]),hasCustomProtocol=r=>{try{const{protocol:t}=new URL(r);return t.endsWith(":")&&!supportedProtocols.has(t)}catch{return!1}},normalizeDataURL=(r,{stripHash:t})=>{var v;const e=/^data:(?<type>[^,]*?),(?<data>[^#]*?)(?:#(?<hash>.*))?$/.exec(r);if(!e)throw new Error(`Invalid URL: ${r}`);let{type:o,data:s,hash:n}=e.groups;const a=o.split(";");n=t?"":n;let h=!1;a[a.length-1]==="base64"&&(a.pop(),h=!0);const d=((v=a.shift())==null?void 0:v.toLowerCase())??"",y=[...a.map(g=>{let[x,E=""]=g.split("=").map(U=>U.trim());return x==="charset"&&(E=E.toLowerCase(),E===DATA_URL_DEFAULT_CHARSET)?"":`${x}${E?`=${E}`:""}`}).filter(Boolean)];return h&&y.push("base64"),(y.length>0||d&&d!==DATA_URL_DEFAULT_MIME_TYPE)&&y.unshift(d),`data:${y.join(";")},${h?s.trim():s}${n?`#${n}`:""}`};function normalizeUrl(r,t){if(t={defaultProtocol:"http",normalizeProtocol:!0,forceHttp:!1,forceHttps:!1,stripAuthentication:!0,stripHash:!1,stripTextFragment:!0,stripWWW:!0,removeQueryParameters:[/^utm_\w+/i],removeTrailingSlash:!0,removeSingleSlash:!0,removeDirectoryIndex:!1,removeExplicitPort:!1,sortQueryParameters:!0,...t},typeof t.defaultProtocol=="string"&&!t.defaultProtocol.endsWith(":")&&(t.defaultProtocol=`${t.defaultProtocol}:`),r=r.trim(),/^data:/i.test(r))return normalizeDataURL(r,t);if(hasCustomProtocol(r))return r;const e=r.startsWith("//");!e&&/^\.*\//.test(r)||(r=r.replace(/^(?!(?:\w+:)?\/\/)|^\/\//,t.defaultProtocol));const s=new URL(r);if(t.forceHttp&&t.forceHttps)throw new Error("The `forceHttp` and `forceHttps` options cannot be used together");if(t.forceHttp&&s.protocol==="https:"&&(s.protocol="http:"),t.forceHttps&&s.protocol==="http:"&&(s.protocol="https:"),t.stripAuthentication&&(s.username="",s.password=""),t.stripHash?s.hash="":t.stripTextFragment&&(s.hash=s.hash.replace(/#?:~:text.*?$/i,"")),s.pathname){const a=/\b[a-z][a-z\d+\-.]{1,50}:\/\//g;let h=0,d="";for(;;){const y=a.exec(s.pathname);if(!y)break;const v=y[0],g=y.index,x=s.pathname.slice(h,g);d+=x.replace(/\/{2,}/g,"/"),d+=v,h=g+v.length}const T=s.pathname.slice(h,s.pathname.length);d+=T.replace(/\/{2,}/g,"/"),s.pathname=d}if(s.pathname)try{s.pathname=decodeURI(s.pathname)}catch{}if(t.removeDirectoryIndex===!0&&(t.removeDirectoryIndex=[/^index\.[a-z]+$/]),Array.isArray(t.removeDirectoryIndex)&&t.removeDirectoryIndex.length>0){let a=s.pathname.split("/");const h=a[a.length-1];testParameter(h,t.removeDirectoryIndex)&&(a=a.slice(0,-1),s.pathname=a.slice(1).join("/")+"/")}if(s.hostname&&(s.hostname=s.hostname.replace(/\.$/,""),t.stripWWW&&/^www\.(?!www\.)[a-z\-\d]{1,63}\.[a-z.\-\d]{2,63}$/.test(s.hostname)&&(s.hostname=s.hostname.replace(/^www\./,""))),Array.isArray(t.removeQueryParameters))for(const a of[...s.searchParams.keys()])testParameter(a,t.removeQueryParameters)&&s.searchParams.delete(a);if(!Array.isArray(t.keepQueryParameters)&&t.removeQueryParameters===!0&&(s.search=""),Array.isArray(t.keepQueryParameters)&&t.keepQueryParameters.length>0)for(const a of[...s.searchParams.keys()])testParameter(a,t.keepQueryParameters)||s.searchParams.delete(a);if(t.sortQueryParameters){s.searchParams.sort();try{s.search=decodeURIComponent(s.search)}catch{}}t.removeTrailingSlash&&(s.pathname=s.pathname.replace(/\/$/,"")),t.removeExplicitPort&&s.port&&(s.port="");const n=r;return r=s.toString(),!t.removeSingleSlash&&s.pathname==="/"&&!n.endsWith("/")&&s.hash===""&&(r=r.replace(/\/$/,"")),(t.removeTrailingSlash||s.pathname==="/")&&s.hash===""&&t.removeSingleSlash&&(r=r.replace(/\/$/,"")),e&&!t.normalizeProtocol&&(r=r.replace(/^http:\/\//,"//")),t.stripProtocol&&(r=r.replace(/^(?:https?:)?\/\//,"")),r}function urlMatches(r,t){let e=!1;return t==null?!1:r===!0?!0:(t=normalizeUrl(t),r instanceof URL&&(e=normalizeUrl(r.href)==t),typeof r=="string"&&(e=normalizeUrl(r)==t),r instanceof RegExp&&(e=r.test(t)),e)}function headersMatches(r,t){let e=!1;if(Object.keys(r).length==0)return!0;for(const s of Object.keys(r)){const n=r[s],a=t.get(s);if(a==null)return!1;if(n===!0)return!0;if(n instanceof URL?e=normalizeUrl(n.href)==normalizeUrl(a):n instanceof RegExp?e=n.test(a):e=String(n)==a,!e)return!1}return e}function fetchInterceptorFactory(r,t){return async function(o,s){const n=new Request(o,s),a=r.interceptRequest(n);return a.blocked?Response.error():t(a).then(h=>r.interceptResponse(h))}}class NetworkInterceptor{constructor({global:t=globalThis,fetchKey:e="fetch",xmlHttpRequestKey:o="XMLHttpRequest"}={}){w(this,b,[]);w(this,k,[]);w(this,M,void 0);w(this,L,void 0);w(this,R,void 0);w(this,F,void 0);f(this,M,t[e]),f(this,L,t[e]=fetchInterceptorFactory(this,i(this,M))),f(this,R,t[o]),f(this,F,t[o])}get windowFetch(){return i(this,M)}get patchedFetch(){return i(this,L)}interceptRequest(t){let e=t;e.blocked=!1;for(const o of i(this,b))if(urlMatches(o.url,e.url)&&headersMatches(o.headers,e.headers)){if(o.block){e.blocked=!0;break}if(o.redirect&&(e=new Request(o.redirect,e),e.blocked=!1),o.callback(e),e.blocked)break}return e}interceptResponse(t){const e=t;for(const o of i(this,k))urlMatches(o.url,e.url)&&headersMatches(o.headers,e.headers)&&o.callback(e);return e}addRule(t,e,o,s){let n;if(t.constructor==Object){if(n=t,!n.type)throw new TypeError("missing type option");if(!n.callback)throw new TypeError("missing callback option")}else n={type:t,url:e,callback:o,...s};return n.headers??(n.headers={}),n.type=="request"?i(this,b).push(n):n.type=="response"&&i(this,k).push(n),n}removeRule(t){if(t.type=="request"){const e=i(this,b).findIndex(o=>o==t);i(this,b).splice(e,1)}else{const e=i(this,k).findIndex(o=>o==t);i(this,k).splice(e,1)}}clearRules(){i(this,b).length=0,i(this,k).length=0}patchFetch(){window.fetch=i(this,L)}restoreFetch(){window.fetch=i(this,M)}}b=new WeakMap,k=new WeakMap,M=new WeakMap,L=new WeakMap,R=new WeakMap,F=new WeakMap,exports.HTMLEntityMap=HTMLEntityMap,exports.JobErrorEvent=JobErrorEvent,exports.JobFinishedEvent=JobFinishedEvent,exports.JobNotFound=JobNotFound,exports.NetworkInterceptor=NetworkInterceptor,exports.WorkerDeadState=WorkerDeadState,exports.WorkerJQ=WorkerJQ,exports.WorkerScriptError=WorkerScriptError,exports.WorkerUnreponsiveError=WorkerUnreponsiveError,exports.awaitDomContentLoaded=awaitDomContentLoaded,exports.escapeHTML=escapeHTML,exports.escapeRegExp=escapeRegExp,exports.executeQuery=executeQuery,exports.formatString=formatString,exports.fromHTML=fromHTML,exports.headersMatches=headersMatches,exports.html=html,exports.makeMutationObserver=makeMutationObserver,exports.observeMutation=observeMutation,exports.observeMutationAsync=observeMutationAsync,exports.observeMutationOnce=observeMutationOnce,exports.urlMatches=urlMatches,exports.waitForElement=waitForElement,exports.waitForElementAll=waitForElementAll,exports.waitForElementId=waitForElementId,exports.waitForElementInf=waitForElementInf,exports.waitForElementParent=waitForElementParent,Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"})});
//# sourceMappingURL=oxi.umd.js.map
